import{r as o,h as n,i as l,n as f,j as i,k as p,_ as m,l as h,o as w,d as U,e as A,p as S,m as y,g as x}from"./index-WfzvT7mn.js";import{d as b}from"./destructLDAP-DC2feZqL.js";async function I(c,s){const e=o([]);if(await n("GET",!1,e,l.apiUrl+"api/account/getbylogin/"+c),e.value&&e.value.status==404)await T(c,s);else{await n("PUT",!1,e,l.apiUrl+"api/account/login/"+c);var a={acc_id:e.value.acc_id,acc_fullname:e.value.acc_fullname,acc_lastlogin:e.value.acc_lastlogin,acc_validateacc:e.value.acc_validateacc};await n("GET",!1,e,l.apiUrl+"api/access/getbylogin/"+c),e.value.count==1?a.acc_access=e.value.access.acs_accounttype:a.acc_access=0,_(a),s.push({name:"Dashboard"})}}async function T(c,s){const e=o([]),a=o([]);try{if(await n("GET",!1,a,"https://srv-peda.iut-acy.local/ldama/ldap/?login="+c),await f(),a.value.message=="Network Error"){i("error",{data:{error:"Une erreur s'est produite lors de la connexion.",message:"Impossible de récupérer les informations de l'utilisateur."}}),p().logoutAccount(),window.open(l.apiUrl+"cas.php?logout=true","_blank"),s.push({name:"Accueil"});return}e.value=b(c,a.value[0].dn);const t={acc_id:e.value.login,acc_fullname:e.value.fullname};if(await n("POST",!1,a,l.apiUrl+"api/account",t),a.value.status&&a.value.status===201){const r={acc_id:a.value.account.acc_id,acc_fullname:a.value.account.acc_fullname,acc_lastlogin:a.value.account.acc_lastlogin,acc_validateacc:a.value.account.acc_validateacc,acc_access:a.value.access};_(r),s.push({name:"Dashboard"})}}catch(t){console.error("Une erreur est survenue (register_acc_auth):",t),i("error",{data:{error:"Une erreur s'est produite lors de la connexion.",message:t.message}}),s.push({name:"Accueil"});return}}function _(c){p().loginAccount(c)}const E=c=>(S("data-v-6fd1d438"),c=c(),y(),c),k={class:"m-5 flex justify-center items-center flex-col pt-72"},G=E(()=>x("p",{class:"text-2xl font-bold"},"Redirection en cours...",-1)),L=[G],R={__name:"login",setup(c){const s=h(),e=o(null),a=o(null),t=o([]),r=o([]),v=p();w(()=>{e.value=localStorage.getItem("login"),a.value=localStorage.getItem("auth"),a.value=="success"?g():v.isLogged()?s.push({name:"Dashboard"}):s.push({name:"Accueil"})});async function g(){try{await n("GET",!1,t,l.apiUrl+"api/acceptedaccount/getbylogin/"+e.value),await n("GET",!1,r,l.apiUrl+"api/access/getbylogin/"+e.value);const u=t.value&&t.value.account,d=r.value&&r.value.access;u||d?await I(e.value,s):(i("error",{data:{error:"Vous n'êtes pas autorisé à accéder à la partie connectée.",message:"Veuillez vous renseigner auprès du service ILC."}}),s.push({name:"Accueil"}))}catch(u){i("error",{data:{error:"Une erreur s'est produite lors de la connexion.",message:u.message}}),s.push({name:"Accueil"})}}return(u,d)=>(U(),A("div",k,L))}},N=m(R,[["__scopeId","data-v-6fd1d438"]]);export{N as default};
